---
title: [ELASTIC] Elastic searching algorithm is BM25
date: 2019-04-26
categories : [Elastic]
---

## Elasticsearch의 Relevance

relevance는 elasticsearch의 query의 score값이다. 즉 쿼리에 맞는 가장 비슷한 값에 점수를 메겨 랭크를 도출할 수 있다. 가장 많이 사용되는 오픈소스 검색엔진인 lucene을 사용하는 elasticsearch는 최근에 lucene의 바뀐 알고리즘으로 인해 기존 TFIDF 변형 알고리즘에서 BM25 알고리즘을 사용하고 있다.

우선 BM25 알고리즘이 무엇인지 살펴보자.

![image](https://user-images.githubusercontent.com/48308562/56791747-ce502580-6842-11e9-906c-aac9af9077dc.png)

식으로만 봐서는 무슨 말인지 잘 모르겠습니다. kibana에서 데이터를 구성하고 query를 주어 score값을 확인하고 `"explain": true`를 통하여 어떻게 계산되는지 확인해 봅시다.

```javascript
POST library/books/_bulk
{"index":{"_id":1}}
{"title":"The quick brow fox",
{"index":{"_id":2}}
{"title":"The quick brow fox jumps over the lazy dog",
{"index":{"_id":3}}
{"title":"The quick brow fox jumps over the quick dog",
{"index":{"_id":4}}
{"title":"brow fox brown dog",
{"index":{"_id":5}}
{"title":"Lazy dog"}
```

 POST를 통해 비슷한 단어로 구성된 5개의 document(row)를 library index(DB) books type(table)에 저장합니다.  _bulk'는 한번에 많은 document를 Insert할 때 필요한 쿼리 API입니다. (price와 colors Field도 존재했지만 코드가 길어져 생략했습니다.)

```javascript
 GET library/_search
{
  "query": {
    "match": {
      "title": "fox jumps"
    }
  },
  "explain": true
}
```

GET을 통해 title field안에서 fox jumps라는 텍스트열과 가장 비슷한 텍스트열을 찾아줍니다.

```javascript
"max_score" : 0.9317306

"_score" : 0.9317306
"title": "The quick brow fox jumps over the lazy dog"

"value" : 0.2876821,
"description" : "idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:",

"value" : 0.36410922,
"description" : "tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:",
```
